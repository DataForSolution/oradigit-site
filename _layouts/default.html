<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page.title }} | OraDigit</title>
  <meta name="description" content="{{ page.description | default: 'OraDigit â€“ Anchored in Trust. Driven by Data.' }}">
  <link rel="icon" href="{{ '/assets/logo.png' | relative_url }}" type="image/png">
  <link rel="stylesheet" href="{{ '/assets/css/style.css?v=2' | relative_url }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  {% seo %}
 <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "OraDigit",
  "url": "https://oradigit.com",
  "logo": "https://oradigit.com/assets/logo.png",
  "description": "AI & data science solutions for healthcare and beyondâ€”strategy, PET/CT denial reduction, automation, and MLOps.",
  "sameAs": [
    "https://www.linkedin.com/company/oradigit" 
  ]
}
</script>

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"WebSite",
  "url":"https://oradigit.com",
  "name":"OraDigit",
  "potentialAction":{
    "@type":"SearchAction",
    "target":"https://oradigit.com/search/?q={search_term_string}",
    "query-input":"required name=search_term_string"
  }
}
</script>

<link rel="canonical" href="{{ page.url | absolute_url }}">

   <!-- 1) Google Tag Manager (Head snippet) -->
  <script>
    (function(w,d,s,l,i){
      w[l]=w[l]||[]; w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0],
          j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GT-PJWHFQQ4');
  </script>
  <!-- End Google Tag Manager -->

  <!-- 2) Google tag (gtag.js) with Consent Mode -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKVXD8061R"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    // Start with analytics denied until user consents
    gtag('consent','default',{ analytics_storage:'denied' });

    // Load GA4
    gtag('js', new Date());
    gtag('config','G-FKVXD8061R',{ send_page_view:true });
  </script>
 <link rel="stylesheet" href="{{ '/assets/css/style.css?v=2' | relative_url }}">
{% if page.custom_css %}
<link rel="stylesheet" href="{{ page.custom_css | relative_url }}">
{% endif %}

{% if page.url contains '/order-helper/' %}
  <!-- Relaxed CSP for Order Helper so it can load Firebase + Firestore -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://www.gstatic.com 'unsafe-inline';
                 connect-src 'self' https://firestore.googleapis.com;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline'">

  <!-- Order Helper styles + meta for rules + cache-busting -->
  <link rel="stylesheet" href="{{ '/order-helper/style.css' | relative_url }}?v=20250919">
  <meta name="oh-rules-path" content="{{ '/order-helper/data/rules.json' | relative_url }}?v=20250919">
  <meta name="oh-version" content="20250919">
{% endif %}

</head>
<body>
  <!-- 4) Google Tag Manager (noscript fallback) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GT-PJWHFQQ4"
            height="0" width="0"
            style="display:none;visibility:hidden"></iframe>
  </noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- â€¦rest of your body contentâ€¦ -->

  {% include navigation.html %}
  <main class="page-content">
    {{ content }}
  {% if page.last_updated %}
  <p class="page-updated" style="margin-top:1rem; font-size:.9rem; color:#6b7280;">
    Last updated: {{ page.last_updated }}
  </p>
{% endif %}
  

  </main>
  {% include footer.html %}
<!-- 1) Back to Top Button Styles -->
<style>
  #backToTop {
    display: none;             /* Hidden until scroll */
    position: fixed;
    bottom: 20px;              /* 20px from bottom */
    left: 20px;                /* 20px from left, avoids chatbot */
    z-index: 10001;            /* Above everything */
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    background-color: #007bff;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    display: flex;             /* center arrow */
  }
  #backToTop:hover {
    background-color: #0056b3;
  }
</style>

<!-- 2) Back to Top Button -->
<button id="backToTop" title="Back to Top">â†‘</button>

<!-- 3) Back to Top Script -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const backToTop = document.getElementById('backToTop');
    if (!backToTop) return;

    // Show or hide based on scroll
    window.addEventListener('scroll', () => {
      backToTop.style.display = window.scrollY > 300 ? 'flex' : 'none';
    });

    // Smooth scroll to top
    backToTop.addEventListener('click', (e) => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>

</script>
  <!-- â€¦your existing page contentâ€¦ -->
 
  
    <!-- Chatbot Widget -->
   <!-- Chatbot Send-Button Styles -->
<style>
  #chatbot-send {
    background-color: #007bff;      /* blue */
    color: #fff;                    /* white text */
    border: none;
    padding: 0.5em 1em;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #chatbot-send:hover {
    background-color: #0056b3;      /* darker blue on hover */
  }
  #chatbot-send:active {
    background-color: #28a745;      /* green while clicked */
  }
</style>

      <div id="chatbot-container">
     <button
  id="chatbot-toggle"
  aria-label="Chat with OraDigit"
  title="Chat with OraDigit"
>
  ðŸ’¬
</button>

    <div id="chatbot-box" class="hidden">
      <div id="chatbot-header">OraDigit Assistant</div>
      <div id="chatbot-messages"></div>
      <div id="chatbot-controls" style="display:flex; gap:0.5em; padding:0.5em;">
        <input id="chatbot-input"
               placeholder="Ask me anythingâ€¦"
               autocomplete="off"
               style="flex:1;"/>
        <button id="chatbot-send">Send</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Use your Firebaseâ€hosted function on your custom domain
      const CHAT_URL = "https://auth.oradigit.com/chat";
      console.log("ðŸ›  Widget loadedâ€”CHAT_URL =", CHAT_URL);

      const toggleBtn = document.getElementById('chatbot-toggle');
      const box       = document.getElementById('chatbot-box');
      const input     = document.getElementById('chatbot-input');
      const sendBtn   = document.getElementById('chatbot-send');
      const messages  = document.getElementById('chatbot-messages');

      // 1) Toggle the chat window
      toggleBtn.addEventListener('click', () => {
        box.classList.toggle('hidden');
        gtag('event', 'chatbot_open', { widget: 'ora-digit-assistant' });
      });

      // 2) Common send logic
      async function sendMessage() {
        const prompt = input.value.trim();
        if (!prompt) return;
        gtag('event', 'chatbot_send', {
        prompt_length: prompt.length,
        widget: 'assistant'
      });

        messages.innerHTML += `<div><strong>You:</strong> ${prompt}</div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        try {
          const res = await fetch(CHAT_URL, {
            method:  'POST',
            mode:    'cors',
            headers: { 'Content-Type': 'application/json' },
            body:    JSON.stringify({ prompt })
          });
          console.log("ðŸ›  fetch status:", res.status);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const { reply } = await res.json();
          gtag('event', 'chatbot_reply', {
          reply_length: reply.length,
          widget: 'assistant'
        });
          messages.innerHTML += `<div><strong>Assistant:</strong> ${reply}</div>`;
          messages.scrollTop = messages.scrollHeight;
        } catch (err) {
          console.error("ðŸ›  chat error:", err);
          gtag('event', 'chatbot_error', {
          error_message: err.message,
          widget: 'assistant'
        });
          messages.innerHTML +=
            `<div style="color:red;"><strong>Error:</strong> ${err.message}</div>`;
          messages.scrollTop = messages.scrollHeight;
        }
      }

      // 3) Send on Enter
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage();
      });
      // 4) Send on button click
      sendBtn.addEventListener('click', sendMessage);
    })();
  </script>
 <script>
  // Mobile hamburger toggle
  const navToggle = document.querySelector('.nav-toggle');
  const mainNav = document.getElementById('primary-nav');
  if (navToggle && mainNav) {
    navToggle.addEventListener('click', () => {
      const isOpen = mainNav.classList.toggle('open');
      navToggle.setAttribute('aria-expanded', String(isOpen));
    });
  }

  // Keyboard/accessibility for dropdowns
  document.querySelectorAll('.has-dropdown').forEach(group => {
    const btn = group.querySelector('.dropdown-toggle');
    const menu = group.querySelector('.dropdown-menu');
    if (!btn || !menu) return;

    btn.addEventListener('click', (e) => {
      // On desktop this isnâ€™t needed, but on mobile it gives a tap-to-open feel
      e.preventDefault();
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      // On mobile, menus are inline so no show/hide needed
    });

    // Close on Escape
    group.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        btn.setAttribute('aria-expanded', 'false');
        btn.blur();
      }
    });
  });
{% if page.url contains '/order-helper/' %}
  <!-- Firebase client config (same one admin uses) -->
  <script src="/order-helper/admin/firebase-config.js"></script>

  <!-- Public rules loader: reads /published_rules/{mod}/v1; falls back to local rules.json -->
  <script type="module">
    const cfg = window.ORADIGIT_FIREBASE_CONFIG || window.FIREBASE_CONFIG;

    function beacon(msg, type='info') {
      let el = document.getElementById('oh-status');
      if (!el) {
        el = document.createElement('div');
        el.id = 'oh-status';
        el.style.cssText = 'margin:.5rem 0;padding:.5rem .75rem;border-radius:10px;font:14px/1.35 system-ui;border:1px solid #ddd;background:#f8fafc;';
        (document.querySelector('main') || document.body).prepend(el);
      }
      el.textContent = msg;
      el.style.borderColor = type==='error' ? '#ff3b30' : (type==='ok' ? '#34c759' : '#ddd');
      el.style.background  = type==='error' ? '#ffecec' : (type==='ok' ? '#e6ffed'  : '#f8fafc');
    }

    async function loadPublished(mod = 'petct') {
      try {
        const [{ initializeApp, getApps }, { getFirestore, doc, getDoc }] =
          await Promise.all([
            import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js')
          ]);

        const app = getApps().length ? getApps()[0] : initializeApp(cfg);
        const db  = getFirestore(app);

        // Try Firestore "published"
        const snap = await getDoc(doc(db, 'published_rules', mod, 'v1'));
        if (snap.exists()) return { source: 'firestore', records: snap.data().records || [] };

        // Fallback to local JSON
        const res = await fetch(`/order-helper/data/rules.json?v=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`rules.json HTTP ${res.status}`);
        const json = await res.json();
        return { source: 'local', records: Array.isArray(json.records) ? json.records : [] };
      } catch (e) {
        console.error(e);
        beacon('Rules load failed: ' + e.message, 'error');
        return { source: 'error', records: [] };
      }
    }

    function populateUI(records) {
      // Expect fields: modality, region (strings); others optional
      const uniq = (a) => [...new Set(a.filter(Boolean))].sort();

      // Try common selectors used in your app; adjust if your IDs differ
      const modSel    = document.querySelector('#modality, select[name="modality"]');
      const regionSel = document.querySelector('#region, select[name="region"]');

      const modalities = uniq(records.map(r => r.modality));
      const regionsByMod = {};
      records.forEach(r => {
        if (!regionsByMod[r.modality]) regionsByMod[r.modality] = new Set();
        if (r.region) regionsByMod[r.modality].add(r.region);
      });

      function setOptions(sel, values, placeholder='Selectâ€¦') {
        if (!sel) return;
        sel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value = ''; ph.disabled = true; ph.selected = true;
        ph.textContent = placeholder;
        sel.appendChild(ph);
        values.forEach(v => {
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        });
        sel.disabled = false;
      }

      setOptions(modSel, modalities, 'Select modality');

      if (modSel && regionSel) {
        modSel.addEventListener('change', () => {
          const m = modSel.value;
          const regions = uniq(Array.from(regionsByMod[m] || []));
          setOptions(regionSel, regions, 'Select region');
        });
      }

      if (!modSel) console.warn('Modality select not found (#modality or [name="modality"]).');
      if (!regionSel) console.warn('Region select not found (#region or [name="region"]).');
    }

    (async () => {
      beacon('Loading rulesâ€¦');
      const { source, records } = await loadPublished('petct');
      if (!records.length) { beacon('No rules found (published or local).', 'error'); return; }
      beacon(`Rules loaded from ${source}.`, 'ok');
      populateUI(records);
    })();
  </script>

  <!-- Small CSS fix so options are visible in dark themes -->
  <style>
    select, select option { color:#0f172a; background:#fff; }
    select:disabled { color:#64748b; }
  </style>
{% endif %}

</body>
</html>
